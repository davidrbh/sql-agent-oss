services:
  # -------------------------------------------------------
  # 1. SIDECAR: MySQL (Node.js)
  # -------------------------------------------------------
  mcp-mysql:
    container_name: mcp-mysql
    build:
      context: . # Contexto Raíz
      dockerfile: services/mcp-mysql-sidecar/Dockerfile
    networks:
      - sql-agent-network
    env_file:
      - .env
    environment:
      - MYSQL_HOST=${DB_HOST}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_PORT=3306
      - PORT=3002
    ports:
      - "3002:3002"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # -------------------------------------------------------
  # 2. CEREBRO: Agent Host (Python API)
  # -------------------------------------------------------
  agent-host: &agent-base # Anchor para reutilizar configuración
    container_name: agent-host
    build:
      context: . # Contexto Raíz
      dockerfile: apps/agent-host/Dockerfile
    networks:
      - sql-agent-network
    env_file:
      - .env
    environment:
      - SIDECAR_URL=http://mcp-mysql:3002
      - PYTHONPATH=/app/src
      - SWAGGER_JSON_PATH=/app/docs/swagger.json
      - BUSINESS_CONTEXT_PATH=/app/config/business_context.yaml
    volumes:
      # Volúmenes mapeados según tu Tree real
      - ./apps/agent-host/src:/app/src
      - ./config:/app/config
      - ./docs:/app/docs
      - ./scripts:/app/scripts
      - ./apps/agent-host/docker-entrypoint.sh:/app/docker-entrypoint.sh
      - ./data:/app/data
    depends_on:
      - mcp-mysql
    ports:
      - "8000:8000"
    # Comando ajustado al PYTHONPATH=/app/src
    command: uvicorn src.api.server:app --host 0.0.0.0 --port 8000 --reload

  # -------------------------------------------------------
  # 3. CANAL: Telegram Bot
  # -------------------------------------------------------
  telegram-bot:
    <<: *agent-base # Hereda todo de agent-host
    container_name: telegram-bot
    ports: [] # No expone puertos
    # Ruta ajustada: src/... es relativo a /app
    command: python src/channels/telegram/entry.py
    restart: unless-stopped
    environment:
      - SIDECAR_URL=http://mcp-mysql:3002
      - PYTHONPATH=/app/src
      - SWAGGER_JSON_PATH=/app/docs/swagger.json
      - BUSINESS_CONTEXT_PATH=/app/config/business_context.yaml
      - SKIP_GENERATION=true

  # -------------------------------------------------------
  # 4. CANAL: WhatsApp (WAHA)
  # -------------------------------------------------------
  waha:
    container_name: waha
    image: devlikeapro/waha:latest
    networks:
      - sql-agent-network
    ports:
      - "3001:3000"
    env_file:
      - .env
    environment:
      - WHATSAPP_WEBHOOK_URL=http://agent-host:8000/api/webhook
      - WHATSAPP_WEBHOOK_EVENTS=message
      - WHATSAPP_API_KEY=${WAHA_API_KEY}
      - WHATSAPP_SWAGGER_USERNAME=${WHATSAPP_SWAGGER_USERNAME}
      - WHATSAPP_SWAGGER_PASSWORD=${WHATSAPP_SWAGGER_PASSWORD}
    volumes:
      - ./waha_sessions:/app/sessions
    restart: on-failure

  # -------------------------------------------------------
  # 5. DOCUMENTACIÓN
  # -------------------------------------------------------
  docs:
    container_name: docs
    build:
      context: .
      dockerfile: docs.Dockerfile
    networks:
      - sql-agent-network
    ports:
      - "8001:8001"
    volumes:
      - ./docs:/app/docs
      - ./mkdocs.yml:/app/mkdocs.yml

networks:
  sql-agent-network:
    driver: bridge
