services:
  # -------------------------------------------------------
  # 1. SIDECAR: MySQL (Node.js)
  # -------------------------------------------------------
  mcp-mysql:
    container_name: mcp-mysql
    build:
      context: .
      dockerfile: services/mcp-mysql-sidecar/Dockerfile
    networks:
      - sql-agent-network
    env_file:
      - .env
    environment:
      - MYSQL_HOST=${DB_HOST}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_PORT=3306
      - PORT=3002
    ports:
      - "3002:3002"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # -------------------------------------------------------
  # 2. CEREBRO: Agent Host (Python API)
  # -------------------------------------------------------
  agent-host: &agent-base
    container_name: agent-host
    build:
      context: .
      dockerfile: apps/agent-host/Dockerfile
    networks:
      - sql-agent-network
    env_file:
      - .env
    environment:
      - SIDECAR_URL=http://mcp-mysql:3002
      - PYTHONPATH=/app/src
      # üëá CR√çTICO: Para ver los logs en tiempo real
      - PYTHONUNBUFFERED=1
      # üëá CR√çTICO: Para que el Agente encuentre a WAHA
      - WAHA_BASE_URL=http://waha:3000
      - WAHA_API_KEY=${WAHA_API_KEY}
      # üëá CR√çTICO: Para que el Agente sepa su propia URL p√∫blica/interna
      - WHATSAPP_WEBHOOK_URL=http://agent-host:8000/api/v1/webhooks/whatsapp/webhook

      - SWAGGER_JSON_PATH=/app/docs/swagger.json
      - BUSINESS_CONTEXT_PATH=/app/config/business_context.yaml
    volumes:
      - ./apps/agent-host/src:/app/src
      - ./config:/app/config
      - ./docs:/app/docs
      - ./scripts:/app/scripts
      - ./apps/agent-host/docker-entrypoint.sh:/app/docker-entrypoint.sh
      - ./data:/app/data
    depends_on:
      - mcp-mysql
      - waha
    ports:
      - "8000:8000"
    command: uvicorn src.api.server:app --host 0.0.0.0 --port 8000 --reload

  # -------------------------------------------------------
  # 3. CANAL: Telegram Bot
  # -------------------------------------------------------
  telegram-bot:
    <<: *agent-base
    container_name: telegram-bot
    ports: []
    command: python src/channels/telegram/entry.py
    restart: unless-stopped
    environment:
      - SIDECAR_URL=http://mcp-mysql:3002
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1 # Tambi√©n aqu√≠ para ver logs
      - SWAGGER_JSON_PATH=/app/docs/swagger.json
      - BUSINESS_CONTEXT_PATH=/app/config/business_context.yaml
      - SKIP_GENERATION=true

  # -------------------------------------------------------
  # 4. CANAL: WhatsApp (WAHA) - MODO ROOT üõ°Ô∏è
  # -------------------------------------------------------
  waha:
    container_name: waha
    image: devlikeapro/waha:latest-2026.1.3
    # üëá CAMBIO PRINCIPAL: Ejecutar como Root para tener permiso de escritura total
    user: "root"
    networks:
      - sql-agent-network
    ports:
      - "3001:3000"
    env_file:
      - .env
    environment:
      # --- Credenciales ---
      - WHATSAPP_API_KEY=${WAHA_API_KEY}
      - WHATSAPP_SWAGGER_USERNAME=${WHATSAPP_SWAGGER_USERNAME}
      - WHATSAPP_SWAGGER_PASSWORD=${WHATSAPP_SWAGGER_PASSWORD}

      # --- Automatizaci√≥n de Arranque ---
      - WHATSAPP_DEFAULT_ENGINE=WEBJS
      - WHATSAPP_DEFAULT_SESSION=default
      - WHATSAPP_START_SESSION=default

      # --- Configuraci√≥n Base ---
      # Esta URL base se usa si tu c√≥digo Python falla al configurar
      - WHATSAPP_WEBHOOK_URL=http://agent-host:8000/api/v1/webhooks/whatsapp/webhook
      - WHATSAPP_WEBHOOK_EVENTS=message

      # --- Estabilidad de Chrome ---
      # ‚ö†Ô∏è --no-sandbox es OBLIGATORIO al usar user: "root"
      - WAHA_PUPPETEER_ARGS=--disable-dev-shm-usage --no-sandbox
    volumes:
      - ./waha_sessions:/app/.sessions
    restart: on-failure

  # -------------------------------------------------------
  # 5. DOCUMENTACI√ìN
  # -------------------------------------------------------
  docs:
    container_name: docs
    build:
      context: .
      dockerfile: docs.Dockerfile
    networks:
      - sql-agent-network
    ports:
      - "8001:8001"
    volumes:
      - ./docs:/app/docs
      - ./mkdocs.yml:/app/mkdocs.yml

networks:
  sql-agent-network:
    driver: bridge
